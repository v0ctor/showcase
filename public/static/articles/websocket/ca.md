---
title: Coneixent WebSocket
description: An√†lisi de WebSocket, un protocol que permet crear un canal de comunicaci√≥ bidireccional sobre TCP.
date: 2015-11-15
---

## Introducci√≥

Des del principi de la seua exist√®ncia, la Web s'ha constru√Øt al voltant del paradigma petici√≥/resposta d'HTTP: l'usuari carrega una p√†gina i no ocorre res fins que este accedix a la seg√ºent. A partir de l'any 2005, AJAX va comen√ßar a modificar este paradigma afegint la possibilitat de, una vegada carregada la p√†gina, realitzar peticions per a obtenir informaci√≥ addicional del servidor, siga de forma peri√≤dica o a causa de la interacci√≥ de l'usuari. La principal caracter√≠stica d'AJAX √©s que el servidor no pot iniciar una comunicaci√≥ amb el client, ja que √©s este √∫ltim qui sempre pren la iniciativa.

En oposici√≥ a estes tecnologies (conegudes com a _pull_), en les quals el client realitza la petici√≥ d'enviament, existixen les conegudes com _push_, que permeten als servidors enviar informaci√≥ al client en qualsevol moment; normalment quan tenen nova informaci√≥ disponible. Cal destacar que este model no t√© cabuda en la Web a causa de les limitacions del seu propi plantejament, encara que s'han intentat emular aproximacions mitjan√ßant t√®cniques com _long polling_.

El protocol WebSocket planteja un model elegant i senzill de comunicacions per a la Web que no trenca amb les tecnologies ja existents.

Companyies d'√®xit com [Slack](https://slack.com) (missatgeria corporativa), [Trello](https://trello.com) (gesti√≥ de projectes), [WhatsApp](https://web.whatsapp.com) (missatgeria personal) o [Pusher](https://pusher.com) (serveis de comunicacions en temps real) utilitzen WebSocket per a oferir els seus serveis.

## Protocol

WebSocket √©s un protocol que permet crear un canal de comunicaci√≥ bidireccional sobre una sola connexi√≥ TCP. Fou estandarditzat per la Internet Engineering Task Force [[RFC 6455](https://tools.ietf.org/html/rfc6455)] en 2011. Est√† pensat per a ser implementat en navegadors i servidors web, encara que no hi ha cap impediment a l'hora d'implementar-lo en qualsevol altre tipus d'aplicaci√≥ que seguisca el model client/servidor.

Les comunicacions es realitzen a trav√©s dels mateixos ports que utilitza HTTP amb la finalitat d'oferir compatibilitat amb el programari HTTP del costat del servidor ja existent. √âs a dir, quan el protocol treballa directament sobre TCP utilitza el port 80 i quan ho fa sobre TLS utilitza el 443. No obstant a√ß√≤, WebSocket √©s un protocol independent.

El protocol es dividix en dues parts: la **negociaci√≥** i la **transfer√®ncia de dades**. Com este coexistix amb HTTP, la primera comunicaci√≥ ha de realitzar-se necess√†riament a trav√©s d'una <mark>petici√≥</mark> HTTP. Per a√ß√≤, la negociaci√≥ d'obertura comen√ßa amb una petici√≥ _upgrade_ per part del client, que t√© el seg√ºent aspecte:

```http request
GET /chat HTTP/1.1
Host: server.example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Origin: http://example.com
Sec-WebSocket-Protocol: chat, superchat
Sec-WebSocket-Version: 13
```

Cal destacar que l'elecci√≥ del m√®tode GET √©s una decisi√≥ arbitr√†ria presa pels autors de l'esborrany que finalment va quedar plasmada en l'RFC. Aix√≠ i tot, √©s l'√∫nic m√®tode que contempla l'est√†ndard i, per tant, l'√∫nic que s'ha d'utilitzar.

Per la seua banda, si tot va b√©, el servidor respon amb un estat 101 (_switching protocols_), que t√© l'aspecte que seguix:

```http request
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
Sec-WebSocket-Protocol: chat
```

En tots dos casos, tant en la petici√≥ com en la resposta, s'inclouen una s√®rie de cap√ßaleres: obligat√≤ries d'HTTP/1.1 (`Host`), necess√†ries per a establir la negociaci√≥ (`Upgrade`, `Connection` i `Sec-WebSocket-*`) o per q√ºestions relacionades amb model de seguretat escollit per al protocol (`Origin`).

Una vegada el client i el servidor han complit amb la seua part de la negociaci√≥, i √∫nicament si no ha ocorregut cap error, comen√ßa la transfer√®ncia d'informaci√≥. A partir d'eixe moment cada part pot enviar informaci√≥ a plaure sense dependre de l'altra, cosa impossible de fer amb HTTP, AJAX, les tecnologies push en general o t√®cniques m√©s espec√≠fiques com _long polling_. A m√©s, WebSocket aporta avantatges respecte a models com Comet, la implementaci√≥ dels quals no √©s trivial i √©s ineficient per a missatges xicotets.

En WebSocket, la unitat elemental de transfer√®ncia d'informaci√≥ s√≥n els missatges, que estan compostos per una o m√©s trames, cadascuna de les quals t√© un tipus de dades associat que coincidir√† amb el qual tinguen la resta de trames del mateix missatge. Existixen trames que contenen text (que s'interpreta com UTF-8) o informaci√≥ bin√†ria, entre altres tipus. Tamb√© existixen trames de control, pensades per a ser usades pel mateix protocol. La versi√≥ m√©s recent de WebSocket definix sis tipus de trama i deixa deu m√©s reservats per a √∫s futur.

La seg√ºent figura mostra una visi√≥ general d'alt nivell de l'estructura de les trames. Tinga's en compte que el format efectiu de la transfer√®ncia de dades √©s binari (no ASCII) i est√† descrit per les ABNF (_Augmented BNF for Syntax Specifications_) [[RFC 5234](https://tools.ietf.org/html/rfc5234)].

![](/static/articles/websocket/images/frame-format.png)

**Figura 1**: estructura d'una trama WebSocket.

A continuaci√≥ es descriu a grans trets el significat de cada camp:
- `FIN` indica si la trama √©s l'√∫ltima del missatge. Note's que la primera trama pot ser tamb√© l'√∫ltima.
- `RSV1`, `RSV2` i `RSV3` estan reservats per al seu √∫s per part d'extensions.
- `Opcode` definix el tipus de dades que cont√© la trama, explicat anteriorment.
- `Mask` indica si el camp `Payload data` est√† emmascarat. Totes les trames que van dirigides del client al servidor ho estan.
- `Payload length` definix la longitud del camp `Payload data` en bytes. El protocol establix un mecanisme per a poder utilitzar el camp `Extended payload length` per a indicar longituds majors que 127 bytes.
- `Masking-key` cont√© la m√†scara utilitzada per a emmascarar el camp `Payload data` i solament est√† present quan el camp `Mask` √©s 1.
- `Payload data` cont√© la informaci√≥ en si.

D'aix√≤ anterior es dedu√Øx que la fragmentaci√≥ √©s una cosa corrent (i, en cas de missatges molt grans, inevitable) en WebSocket. No obstant a√ß√≤, el protocol est√† pensat perqu√® la fragmentaci√≥ s'utilitze el m√≠nim possible. De fet, s'ha escollit un model basat en fragments per no escollir un basat en fluxos d'informaci√≥, a m√©s de per poder distingir entre tipus d'informaci√≥. Cal assenyalar que en un protocol de nivell d'aplicaci√≥ no tindria molt sentit fragmentar sense una ra√≥.

Finalment, quan una de les parts decidix que ja no hi ha res m√©s per transmetre, √©s possible tancar la connexi√≥ mitjan√ßant una negociaci√≥ de tancament. Este s'inicia enviant un missatge de control espec√≠fic, al qual l'altre extrem respon amb un altre missatge de control per a confirmar que el tancament √©s acordat. La negociaci√≥ de tancament est√† pensada per a anar acompanyada del tancament de la connexi√≥ TCP.

## Seguretat

El model de seguretat de WebSocket √©s el mateix que utilitzen els navegadors web, √©s a dir, l'anomenat model d'origen (igual que AJAX). Per a un servidor web es restringixen les p√†gines des de les quals es pot establir una connexi√≥, evitant aix√≠ vulnerabilitats de _cross-site scripting_. Evidentment, a√ß√≤ solament t√© sentit quan el protocol s'utilitza des d'una p√†gina web.

A m√©s, el proc√©s de negociaci√≥ est√† pensat per a assegurar que ambdues parts estan utilitzant WebSocket i que, per tant, no s'est√† intentant establir una connexi√≥ il¬∑l√≠cita utilitzant, per exemple, HTML i AJAX.

## API

L'API WebSocket HTML5 en Web IDL (un format per a descriure interf√≠cies a implementar en navegadors web) encara est√† sent normalitzada pel World Wide Web Consortium. Esta API orientada a esdeveniments permet als navegadors web utilitzar el protocol a trav√©s de JavaScript en el context d'una aplicaci√≥ web.

### Establiment de la connexi√≥

Per a establir una comunicaci√≥ WebSocket √©s necessari crear un objecte `WebSocket`, que autom√†ticament intentar√† obrir una connexi√≥ amb el servidor. El constructor accepta dos par√†metres: el primer √©s l'URL a la qual connectar-se (obligatori) i el segon √©s una cadena o un vector de cadenes indicant subprotocols que permeten al servidor manejar diferents tipus d'interacci√≥. Este √∫ltim par√†metre √©s opcional.

```
WebSocket WebSocket(
    in DOMString url,
    in optional DOMString protocols
);
```

Si ocorreguera un error durant l'establiment de la connexi√≥, s'enviarien dos esdeveniments a l'objecte: un d'error (invocant al controlador `onerror`) i un altre de tancament de connexi√≥ (invocant al controlador `onclose`).

L'exemple que seguix mostra la forma de crear un objecte `WebSocket` que inicia una connexi√≥ segura sobre TLS (note's el protocol _wss_ en lloc de _ws_) a un dels servidors utilitzats per a oferir el conegut servei de missatgeria WhatsApp Web.

```javascript
var socket = new WebSocket("wss://w7.web.whatsapp.com/ws");
```

### Enviament d'informaci√≥

Una vegada oberta la connexi√≥ √©s possible comen√ßar a enviar informaci√≥ a trav√©s d'ella. Per a a√ß√≤ simplement cal cridar a la funci√≥ `send()` de l'objecte creat.

```javascript
socket.send("Hi! üëã");
```

No obstant a√ß√≤, no √©s una bona pr√†ctica utilitzar este m√®tode ignorant que JavaScript executa el codi de forma as√≠ncrona. Tenint en compte l'anterior, la soluci√≥ implica definir un controlador proporcionat per l'API que √©s cridat quan la connexi√≥ acaba d'establir-se.

```javascript
socket.onopen = function (event) {
    socket.send("Hi! üëã");
};
```

### Recepci√≥ d'informaci√≥

Quan un missatge arriba, es passa autom√†ticament un esdeveniment `message` com a par√†metre a la funci√≥ `onmessage()`. Per a comen√ßar a escoltar en el canal d'entrada solament cal definir el controlador de la seg√ºent forma:

```javascript
socket.onmessage = function (event) {
    console.log(event.data);
};
```

### Tancament de la connexi√≥

Quan s'ha acabat d'enviar i rebre informaci√≥ √©s convenient tancar la connexi√≥ per a no malgastar recursos tant de la m√†quina client com del servidor. Tancar una connexi√≥ √©s tan f√†cil com cridar al m√®tode `close()`:

```javascript
socket.close();
```

### Documentaci√≥

L'[especificaci√≥](https://www.w3.org/TR/websockets/) de l'API es troba disponible en la p√†gina web del World Wide Web Consortium. Tamb√© existix [documentaci√≥](https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API) m√©s amigable desenvolupada per la fundaci√≥ Mozilla i que es troba disponible en la Mozilla Developer Network.

## √Ämbit d'aplicaci√≥

WebSocket es pot utilitzar en pr√†cticament qualsevol plataforma i consta d'implementaci√≥ en altres √†mbits f√≥ra del navegador web. Tinga's en compte que les aplicacions web cobren cada vegada m√©s import√†ncia i per al seu desenvolupament √©s necessari, a m√©s del navegador web en la part del client, un costat servidor que suporte el protocol.

Gran part dels llenguatges m√©s utilitzats l'any 2015 disposen d'API per a WebSocket: C ([Libwebsockets](https://libwebsockets.org)), Java ([javax.websocket](https://docs.oracle.com/javaee/7/api/javax/websocket/package-summary.html)), Objective-C ([SocketRocket](https://github.com/square/SocketRocket)), PHP ([Elephant.IO](https://wisembly.github.io/elephant.io)) i, √≤bviament, JavaScript, entre altres. A m√©s, tamb√© existixen solucions multiplataforma, com [Socket.IO](https://socket.io) per a NodeJS.

### Suport en navegadors web

En la taula que hi ha a continuaci√≥ es mostra, per als navegadors m√©s utilitzats actualment, la versi√≥ des de la qual suporten cadascuna de les definicions de WebSocket. La versi√≥ actual de WebSocket √©s la 17 i √©s la mateixa que es definix en l'[RFC 6455](https://tools.ietf.org/html/rfc6455).

|           | Chrome | Firefox | Opera           | Safari     | Internet Explorer |
| --------- | :----: | :-----: | :-------------: | :--------: | :---------------: |
| Versi√≥ 0  | 6      | 4       | 11 (desactivat) | 5.0.1      | No                |
| Versi√≥ 7  | No     | 6       | No              | No         | No                |
| Versi√≥ 10 | 14     | 7       | Desconegut      | Desconegut | No                |
| Versi√≥ 17 | 16     | 37      | 12.10           | 6          | 10                |

## Avantatges i inconvenients

Com s'ha vist, el protocol permet establir comunicacions bidireccionals en temps real en la Web, possibilitat que abans solament existia de forma simulada i bastant costosa mitjan√ßant t√®cniques com _long polling_. Optar per este protocol permet reduir la saturaci√≥ de cap√ßaleres que ocorreria si s'utilitzara HTTP en el seu lloc, especialment per a aplicacions que requerixen un gran volum de comunicacions. A m√©s, evita que cada aplicaci√≥ utilitze una soluci√≥ d'integraci√≥ diferent, amb els problemes de compatibilitat que aix√≤ comportaria.

D'altra banda, s'ha vist que el seu funcionament √©s extremadament senzill: s'establix una connexi√≥, s'envien/reben missatges i es tanca la connexi√≥. Finalment, en funcionar baix els mateixos ports que HTTP evita problemes relacionats amb tallafocs, facilitant aix√≠ el funcionament de productes basats en arquitectures orientades a serveis (SOA), entre altres.

Per tant, WebSocket √©s la millor soluci√≥ per a aplicacions que necessiten actualitzacions constants en temps real com xats, jocs multijugador en l√≠nia o retransmissions interactives en directe. No obstant a√ß√≤, no resulta una opci√≥ tan v√†lida per a aplicacions que √∫nicament necessiten actualitzacions peri√≤diques o basades en esdeveniments generats per l'usuari.

## Cas real

Despr√©s de veure el funcionament de WebSocket i tot el que pot aportar com a tecnologia de comunicacions a la integraci√≥ d'aplicacions, resulta interessant destacar un cas real en el qual s'utilitza el protocol: WhatsApp Web.

El servei de missatgeria WhatsApp √©s un servei distribu√Øt. El seu client web utilitza WebSocket per a comunicar-se amb els servidors, que s'encarreguen d'emmagatzemar informaci√≥ i retransmetre als clients web la informaci√≥ que sol¬∑liciten indirectament als dispositius m√≤bils.

Utilitzant les eines per a desenvolupadors que proporciona Google Chrome √©s possible analitzar les comunicacions entre un client WhatsApp Web i els servidors del servei.

En la seg√ºent captura de pantalla s'observa la negociaci√≥ d'obertura que inicia el client i la resposta que rep del servidor:

![](/static/articles/websocket/images/chrome-preview-1.png)

**Figura 2**: negociaci√≥ d'obertura vista des de la consola de desenvolupament de Chrome.

A m√©s, tamb√© √©s possible comprovar els missatges enviats i rebuts, i de quin tipus s√≥n:

![](/static/articles/websocket/images/chrome-preview-2.png)

**Figura 3**: missatges WebSocket des de la consola de desenvolupament de Chrome.

## Conclusi√≥

WebSocket permet que dues aplicacions establisquen una comunicaci√≥ bidireccional independentment de la plataforma en la qual estiguen executant-se i del llenguatge en el qual hagen sigut escrites. A m√©s, existixen multitud d'implementacions per a pr√†cticament qualsevol llenguatge que permeten als desenvolupadors centrar-se en les seues aplicacions oblidant-se d'implementar les comunicacions.

A√ß√≤ obri un ventall de possibilitats per a la integraci√≥ d'aplicacions, permetent a estes intercanviar informaci√≥ en temps real i de forma senzilla, contribuint a m√©s a l'estandarditzaci√≥ dels mecanismes de comunicaci√≥.

## Bibliografia

- **Engine Yard.** [WebSocket: 5 Advantages of Using WebSockets](https://www.engineyard.com/articles/websocket). Consulta: 8 de novembre de 2015.
- **Fette, I. i Melnikov, A. (2011).** [The WebSocket Protocol](https://tools.ietf.org/html/rfc6455). Internet Engineering Task Force. Consulta: 28 d'octubre de 2015.
- **Hickson, I. (2012).** [The WebSocket API](https://www.w3.org/TR/websockets). W3C. Consulta: 1 de novembre de 2015.
- **Kitamura, E. i Ubl, M. (2010).** [Introducing WebSockets: Bringing Sockets to the Web](https://www.html5rocks.com/en/tutorials/websockets/basics/). HTML5 Rocks. Consulta: 28 d'octubre de 2015.
- **Mozilla Foundation (2015).** [WebSockets](https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API). Consulta: 8 de novembre de 2015.
- **Tiobe Software (2015).** [TIOBE Index for November 2015](https://www.tiobe.com/index.php/content/paperinfo/tpci/index.html). Consulta: 8 de novembre de 2015.
- **Web Hypertext Application Technology Working Group (2015).** "Web sockets" en [HTML5 Living Standard](https://html.spec.whatwg.org/multipage/comms.html#network), 9.3. Consulta: 1 de novembre de 2015.
